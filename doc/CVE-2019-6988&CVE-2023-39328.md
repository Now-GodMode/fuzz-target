# CVE-2019-6988 & CVE-2023-39328

## 1.漏洞描述

CVE-2019-6988：

An issue was discovered in OpenJPEG 2.3.0. It allows remote attackers to cause a denial of service (attempted excessive memory allocation) in opj_calloc in openjp2/opj_malloc.c, when called from opj_tcd_init_tile in openjp2/tcd.c, as demonstrated by the 64-bit opj_decompress.

CVE-2023-39328：

A vulnerability was found in OpenJPEG similar to CVE-2019-6988. This flaw allows an attacker to bypass existing protections and cause an application crash through a maliciously crafted file.

存在问题的压缩解压缩套件： opj_compress，opj_decompress

CVE-2019-6988 的 poc：https://github.com/uclouvain/openjpeg/issues/1178

poc验证：但是该poc存在问题，文件头应该是损坏的

![1744937638076](image/CVE-2019-6988&CVE-2023-39328/1744937638076.png)

使用漏洞 CVE-2023-39328 的 poc：https://github.com/uclouvain/openjpeg/issues/1471，成功导致系统内存耗尽

![1744938726831](image/CVE-2019-6988&CVE-2023-39328/1744938726831.png)

内存耗尽后系统将自动 killed 该进程

![1744938791699](image/CVE-2019-6988&CVE-2023-39328/1744938791699.png)

## 2.Fuzz

正常编译：

```shell
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make
```

fuzz编译：使用debug模式，并且将套件编译为32位模式，方便asan

```shell
cmake .. -DCMAKE_BUILD_TYPE=Debug \
-DCMAKE_C_COMPILER=$HOME/tool/AFLplusplus/afl-clang-fast \
-DCMAKE_CXX_COMPILER=$HOME/tool/AFLplusplus/afl-clang-fast++  \
-DCMAKE_C_FLAGS="-fsanitize=address -g -m32" \
-DCMAKE_CXX_FLAGS="-fsanitize=address -g -m32"

make -j16
```

再次运行，asan检查出问题：

![1744943120435](image/CVE-2019-6988&CVE-2023-39328/1744943120435.png)

尝试fuzz：需要确保seeds中至少有一个可以正常运行的种子，并且需要确保种子不能太大

```shell
afl-fuzz -i ./pocRep/poc-test -o ./fuzzoutput1 -m 0 -t 10000 -- /home/waiwai/fuzz/fuzz-target-waiwai/OpenJPEG/openjpeg-v2.3.0/build/bin/opj_decompress -i @@ -o test.raw
```

（由于子模块分支修改较为负责，种子文件夹切换至v2.3.0-poc-test）

![1744967114675](image/CVE-2019-6988&CVE-2023-39328/1744967114675.png)

## 3.crash分析
